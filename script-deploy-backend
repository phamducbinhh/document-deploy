#!/bin/bash

# Cáº¥u hÃ¬nh
APP_DIR="/home/dev/app-production/protected-room-be"     # Thay Ä‘á»•i Ä‘Æ°á»ng dáº«n project
APP_NAME="protected-app-backend"             # TÃªn app trong pm2

echo "ğŸš€ Báº¯t Ä‘áº§u deploy á»©ng dá»¥ng Node.js..."

# B1: VÃ o thÆ° má»¥c project
cd $APP_DIR || { echo "âŒ KhÃ´ng tÃ¬m tháº¥y thÆ° má»¥c $APP_DIR"; exit 1; }

# B2: Pull code má»›i nháº¥t
echo "ğŸ“¥ Pull code má»›i nháº¥t..."
git reset --hard
git pull origin main

# B3: CÃ i dependencies
echo "ğŸ“¦ CÃ i Ä‘áº·t dependencies..."
npm install --production

# B4: Build project
echo "ğŸ”¨ Build project..."
npm run build

# B5: Restart / Reload vá»›i PM2
echo "â™»ï¸ Restart á»©ng dá»¥ng vá»›i PM2..."
if pm2 list | grep -q $APP_NAME; then
    pm2 reload $APP_NAME
else
    pm2 start npm --name "$APP_NAME" -- run start
fi

# B6: LÆ°u láº¡i config PM2 (tá»± Ä‘á»™ng restart khi server reboot)
pm2 save

echo "âœ… Deploy thÃ nh cÃ´ng!"
